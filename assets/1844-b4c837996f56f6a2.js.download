try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="fc83885f-390a-4dad-9fe6-05955a68c1d8",e._sentryDebugIdIdentifier="sentry-dbid-fc83885f-390a-4dad-9fe6-05955a68c1d8")}catch(e){}"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1844],{19291:(e,t,r)=>{r.d(t,{d:()=>o});class n{defaultGenerateMessageId(){return Date.now()+Math.random().toString(36).substring(2)}get targetWindow(){if(this.customTargetWindow)return this.customTargetWindow;if(this.isParent){var e;return null===(e=document.querySelector(this.iframeSelector))||void 0===e?void 0:e.contentWindow}return window.parent}get targetOrigin(){return this.customTargetOrigin?this.customTargetOrigin:"*"}allowOrigin(e){let t=this.allowedOrigins.some(t=>new RegExp(t).test(e));if(!t){var r;null===(r=this.logger)||void 0===r||r.warn("Origin rejected",{origin:e,allowedPatterns:this.allowedOrigins})}return t}setTarget(e){var t;this.customTargetWindow=e.window,this.customTargetOrigin=e.origin,null===(t=this.logger)||void 0===t||t.info("Target updated",{hasWindow:!!e.window,origin:e.origin})}addAllowedOrigin(e){if(!this.allowedOrigins.includes(e)){var t;this.allowedOrigins.push(e),null===(t=this.logger)||void 0===t||t.info("Added allowed origin pattern",{pattern:e,totalPatterns:this.allowedOrigins.length})}}removeAllowedOrigin(e){let t=this.allowedOrigins.indexOf(e);if(t>-1){var r;this.allowedOrigins.splice(t,1),null===(r=this.logger)||void 0===r||r.info("Removed allowed origin pattern",{pattern:e,totalPatterns:this.allowedOrigins.length})}}sendEvent(e,t){var r;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e3,i=this.generateMessageId();null===(r=this.logger)||void 0===r||r.info("Sending event",{event:e,messageId:i,dataType:typeof t,maxRetries:n,timeout:o}),this.sendMessageWithRetry({id:i,type:"event",event:e,data:t},n,o)}sendEventWithTransferable(e,t,r){var n;let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e3,s=this.generateMessageId();null===(n=this.logger)||void 0===n||n.info("Sending event with transferable",{event:e,messageId:s,dataType:typeof t,transferableCount:r.length,maxRetries:o,timeout:i}),this.sendMessageWithRetry({id:s,type:"event",event:e,data:t},o,i,r)}invoke(e,t){return new Promise((r,n)=>{var o,i;let s=this.generateMessageId();null===(o=this.logger)||void 0===o||o.info("Invoking remote method",{event:e,messageId:s,dataType:typeof t}),this.invokeCallbacks.set(s,{resolve:r,reject:n});let a=setTimeout(()=>{if(this.invokeCallbacks.get(s)){var t;this.invokeCallbacks.delete(s);let r="Invoke ACK timeout: ".concat(e);null===(t=this.logger)||void 0===t||t.error(r,{event:e,messageId:s}),n(Error(r))}},5e3);this.pending.set(s,{timer:a,attempt:0}),null===(i=this.targetWindow)||void 0===i||i.postMessage({id:s,type:"invoke",event:e,data:t},this.targetOrigin)})}invokeWithTransferable(e,t,r){return new Promise((n,o)=>{var i,s;let a=this.generateMessageId();null===(i=this.logger)||void 0===i||i.info("Invoking remote method with transferable",{event:e,messageId:a,dataType:typeof t,transferableCount:r.length}),this.invokeCallbacks.set(a,{resolve:n,reject:o});let l=setTimeout(()=>{if(this.invokeCallbacks.get(a)){var t;this.invokeCallbacks.delete(a);let r="Invoke ACK timeout: ".concat(e);null===(t=this.logger)||void 0===t||t.error(r,{event:e,messageId:a}),o(Error(r))}},5e3);this.pending.set(a,{timer:l,attempt:0}),null===(s=this.targetWindow)||void 0===s||s.postMessage({id:a,type:"invoke",event:e,data:t},this.targetOrigin,r)})}sendMessageWithRetry(e,t,r,n){var o=this;let i=function(){var s,a;let l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(l>0&&(null===(a=o.logger)||void 0===a||a.warn("Message retry attempt",{event:e.event,messageId:e.id,attempt:l+1,maxAttempts:t+1})),null===(s=o.targetWindow)||void 0===s||s.postMessage(e,o.targetOrigin,n),"event"===e.type){let n=setTimeout(()=>{if(l>=t){var r;o.pending.delete(e.id),null===(r=o.logger)||void 0===r||r.error("Message failed after all retries",{event:e.event,messageId:e.id,totalAttempts:l+1});return}i(l+1)},r*2**l);o.pending.set(e.id,{timer:n,attempt:l})}};i()}listen(){var e;null===(e=this.logger)||void 0===e||e.info("Started listening for messages"),window.addEventListener("message",e=>{var t,r,n;if(!this.allowOrigin(e.origin)||!(null===(t=e.data)||void 0===t?void 0:t.type)||!(null===(r=e.data)||void 0===r?void 0:r.id))return;let o=e.data;switch(null===(n=this.logger)||void 0===n||n.info("Received message",{type:o.type,event:o.event,messageId:o.id,origin:e.origin}),o.type){case"event":this.sendAck(o.id,e.origin);let i=this.eventHandlers[o.event];i&&i.length>0&&i.forEach(e=>{try{e(o.data)}catch(e){var t;null===(t=this.logger)||void 0===t||t.error("Event handler error",{event:o.event,error:e instanceof Error?e.message:String(e)})}});break;case"invoke":this.sendAck(o.id,e.origin),this.handleInvoke(o,e.origin);break;case"response":this.handleResponse(o);break;case"ack":this.handleAck(o)}})}sendAck(e,t){var r;let n={id:this.generateMessageId(),type:"ack",event:"ack",originalId:e};null===(r=this.targetWindow)||void 0===r||r.postMessage(n,t)}async handleInvoke(e,t){var r,n,o,i,s,a,l;try{let a=this.invokeHandlers[e.event];if(!a){let t="No handler for invoke: ".concat(e.event);throw null===(n=this.logger)||void 0===n||n.error(t,{event:e.event,messageId:e.id}),Error(t)}null===(r=this.logger)||void 0===r||r.debug("Executing invoke handler",{event:e.event,messageId:e.id});let l=await a(e.data),d={id:this.generateMessageId(),type:"response",event:"response",originalId:e.id,data:l},c=this.extractTransferableFromResult(l);c.length>0?(null===(o=this.logger)||void 0===o||o.debug("Sending response with transferable objects",{event:e.event,originalId:e.id,transferableCount:c.length}),null===(i=this.targetWindow)||void 0===i||i.postMessage(d,t,c)):null===(s=this.targetWindow)||void 0===s||s.postMessage(d,t)}catch(o){let r=o instanceof Error?o.message:String(o);null===(a=this.logger)||void 0===a||a.error("Invoke handler failed",{event:e.event,messageId:e.id,error:r});let n={id:this.generateMessageId(),type:"response",event:"response",originalId:e.id,error:r};null===(l=this.targetWindow)||void 0===l||l.postMessage(n,t)}}extractTransferableFromResult(e){let t=[];if(!e)return t;if(e.buffer instanceof ArrayBuffer)t.push(e.buffer);else if(e instanceof ArrayBuffer)t.push(e);else if("object"==typeof e)for(let r of Object.values(e))r instanceof ArrayBuffer?t.push(r):r&&"object"==typeof r&&"buffer"in r&&r.buffer instanceof ArrayBuffer&&t.push(r.buffer);return t}handleResponse(e){var t,r,n;let o=this.invokeCallbacks.get(e.originalId);o?(e.error?(null===(t=this.logger)||void 0===t||t.error("Invoke failed with error",{originalId:e.originalId,error:e.error}),o.reject(Error(e.error))):(null===(r=this.logger)||void 0===r||r.info("Invoke completed successfully",{originalId:e.originalId,resultType:typeof e.data}),o.resolve(e.data)),this.invokeCallbacks.delete(e.originalId)):null===(n=this.logger)||void 0===n||n.warn("No callback found for response",{originalId:e.originalId})}handleAck(e){var t,r;let{originalId:n}=e,o=this.pending.get(n);o?(clearTimeout(o.timer),this.pending.delete(n),null===(t=this.logger)||void 0===t||t.debug("ACK received, cleared timeout",{originalId:n})):null===(r=this.logger)||void 0===r||r.warn("Received ACK for unknown message",{originalId:n})}onEvent(e,t){var r;return this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t),null===(r=this.logger)||void 0===r||r.info("Registered event handler",{event:e,handlerCount:this.eventHandlers[e].length}),()=>{let r=this.eventHandlers[e];if(r){let o=r.indexOf(t);if(o>-1){var n;r.splice(o,1),null===(n=this.logger)||void 0===n||n.info("Removed specific event handler",{event:e,remainingHandlers:r.length}),0===r.length&&delete this.eventHandlers[e]}}}}onInvoke(e,t){var r;this.invokeHandlers[e]=t,null===(r=this.logger)||void 0===r||r.info("Registered invoke handler",{event:e})}offInvoke(e){var t;delete this.invokeHandlers[e],null===(t=this.logger)||void 0===t||t.info("Removed invoke handler",{event:e})}updateLogConfig(e){var t;void 0!==e.logger&&(this.logger=e.logger),null===(t=this.logger)||void 0===t||t.info("Log configuration updated",e)}destroy(){var e,t;null===(e=this.logger)||void 0===e||e.info("Starting MessageManager cleanup"),this.pending.forEach((e,t)=>{clearTimeout(e.timer)}),this.pending.clear(),this.invokeCallbacks.forEach((e,t)=>{e.reject(Error("MessageManager destroyed"))}),this.invokeCallbacks.clear(),this.eventHandlers={},this.invokeHandlers={},null===(t=this.logger)||void 0===t||t.info("MessageManager destroyed")}constructor(e){var t;this.eventHandlers={},this.invokeHandlers={},this.invokeCallbacks=new Map,this.isParent=e.isParent,this.pending=new Map,this.allowedOrigins=e.allowedOrigins||["yourware\\.app","yourware\\.so","youware\\.com","localhost|127\\.0\\.0\\.1","csb\\.app"],this.iframeSelector=e.iframeSelector||"#youware-runtime",this.generateMessageId=e.generateMessageId||this.defaultGenerateMessageId,this.logger=e.logger,null===(t=this.logger)||void 0===t||t.info("MessageManager initialized",{envType:this.isParent?"parent":"child",allowedOrigins:this.allowedOrigins,iframeSelector:this.iframeSelector}),this.listen()}}let o=new n({isParent:!0})},91844:(e,t,r)=>{r.d(t,{A:()=>q});var n=r(95155);function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=atob(e),n=Array(r.length);for(let e=0;e<r.length;e++)n[e]=r.charCodeAt(e);return new Blob([new Uint8Array(n)],{type:t})}let i=new Map,s=null,a=null;var l=r(19291),d=r(35695),c=r(12115),h=r(34477);let u=(0,h.createServerReference)("70864e8b5357bb5548f6b0396c48092e508dead20b",h.callServer,void 0,h.findSourceMapURL,"innerRequest");var g=r(46116),f=r(53568),p=r(25427),m=r(62128);let v={maxRetries:3,reportToSentry:!0};class y extends c.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){let n=this.options.componentName||"Unknown";if(m.Ay.error("Error Boundary caught error in ".concat(n),e,{componentName:n,errorInfo:t.componentStack,retryCount:this.state.retryCount}),this.options.reportToSentry&&r.e(1276).then(r.bind(r,51276)).then(r=>{r.captureException(e,{tags:{component:n,errorBoundary:!0},extra:{errorInfo:t,retryCount:this.state.retryCount}})}).catch(e=>{m.Ay.error("Failed to report error to Sentry",e)}),this.options.onError)try{this.options.onError(e,t)}catch(e){m.Ay.error("Error in custom error handler",e)}this.setState({error:e,errorInfo:t})}render(){let{hasError:e,error:t}=this.state,{children:r,fallback:n,renderError:o}=this.props;return e&&t?o?o(t,this.handleRetry):n||this.renderDefaultError(t):r}constructor(e){super(e),this.handleRetry=()=>{let{maxRetries:e=3}=this.options;if(this.state.retryCount>=e){m.Ay.warn("Max retries reached (".concat(e,"). Please refresh the page."));return}if(m.Ay.info("Error Boundary retry attempt",{retryCount:this.state.retryCount+1,maxRetries:e,componentName:this.options.componentName}),this.options.onRetry)try{this.options.onRetry()}catch(e){m.Ay.error("Error in custom retry handler",e)}this.setState({hasError:!1,error:null,errorInfo:null,retryCount:this.state.retryCount+1})},this.handleRefresh=()=>{window.location.reload()},this.renderDefaultError=e=>(0,n.jsxs)("div",{className:"mx-auto flex min-h-[120px] w-full max-w-[280px] items-center justify-center gap-2 p-2 sm:max-w-sm sm:gap-3 sm:p-4",children:[(0,n.jsx)("div",{className:"flex h-6 w-6 items-center justify-center rounded-full bg-[#55644A]/10 sm:h-8 sm:w-8",children:(0,n.jsx)(p.sFm,{className:"h-3 w-3 text-[#55644A] sm:h-4 sm:w-4"})}),(0,n.jsx)("h3",{className:"text-sm font-medium text-[#55644A] sm:text-base",children:"Something went wrong"})]}),this.state={hasError:!1,error:null,errorInfo:null,retryCount:0},this.options={...v,...e}}}function w(e){let t=(0,c.useRef)(e);return t.current=e,(0,c.useCallback)(function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];let o=t.current;return null==o?void 0:o(...r)},[])}var k=r(4821),I=r(56389),b=r(84842),E=r(66139),x=r(48436);let R=(0,m.tZ)("Fetch Monitor"),T=(0,h.createServerReference)("40e9d3331271713c169ab48e54571f7d1a99cc3a6d",h.callServer,void 0,h.findSourceMapURL,"getUserTokenForAIProject");class A extends Error{constructor(e,t,r=!1){super(e),this.code=t,this.retryable=r,this.name="TokenManagerError"}}class C{static async fetchToken(e){var t,r;let n=await T({project_id:e});if(0!==n.code)throw S.error("Failed to fetch token",{projectId:e,error:n.message||"Unknown error"}),Error("Failed to fetch token: ".concat(n.message||"Unknown error"));if(!(null===(t=n.data)||void 0===t?void 0:t.token)||!(null===(r=n.data)||void 0===r?void 0:r.expires_in))throw S.error("Invalid token response",{projectId:e,error:"Missing token or expires_in"}),Error("Invalid token response: missing token or expires_in");return{token:n.data.token,expires_in:n.data.expires_in}}}let S=(0,m.tZ)("LLMToken");class M{async getToken(){if(this.isDestroyed)throw new A("TokenManager has been destroyed","DESTROYED");if(this.tokenInfo&&this.tokenInfo.expiresTime>Date.now())return this.tokenInfo.token;if(this.refreshPromise||(this.refreshPromise=this.refreshToken()),await this.refreshPromise,!this.tokenInfo)throw new A("Failed to obtain token","FETCH_FAILED");return this.tokenInfo.token}async forceRefresh(){if(this.isDestroyed)throw new A("TokenManager has been destroyed","DESTROYED");this.clearRefreshTimer(),this.refreshPromise=this.refreshToken(),await this.refreshPromise}destroy(){this.isDestroyed=!0,this.clearRefreshTimer(),this.tokenInfo=null,this.refreshPromise=null}async refreshToken(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!this.isDestroyed){this.clearRefreshTimer();try{S.info("Refreshing llm-token",{projectId:this.config.projectId});let e=await this.tokenFetcher(this.config.projectId);if(!e.token||!e.expires_in)throw new A("Invalid token response","INVALID_RESPONSE",!0);this.tokenInfo={token:e.token,expiresTime:Date.now()+1e3*e.expires_in-5e3},this.scheduleNextRefresh(e.expires_in),this.refreshPromise=null,S.info("llm-token refreshed successfully",{projectId:this.config.projectId,expiresIn:e.expires_in})}catch(t){if(this.isRetryableError(t)&&e<this.config.retryConfig.maxAttempts){let r=this.calculateRetryDelay(e);if(S.error("Retrying llm-token fetch (attempt ".concat(e+1,"/").concat(this.config.retryConfig.maxAttempts,") in ").concat(r,"ms"),{projectId:this.config.projectId,error:t}),await new Promise(e=>{this.refreshTimer=setTimeout(e,r)}),!this.isDestroyed)return this.refreshToken(e+1)}else{this.refreshPromise=null;let r=t instanceof Error?t.message:String(t),n=new A("Failed to fetch token after ".concat(e+1," attempts: ").concat(r),"MAX_RETRIES_EXCEEDED");throw S.error("Failed to fetch token after ".concat(this.config.retryConfig.maxAttempts," attempts"),n,{projectId:this.config.projectId,originalError:t}),n}}}}scheduleNextRefresh(e){if(this.isDestroyed)return;let t=Math.max((e-this.config.refreshAdvanceTime)*1e3,1e3);this.refreshTimer=setTimeout(()=>{this.isDestroyed||(this.refreshPromise=this.refreshToken())},t)}clearRefreshTimer(){this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null)}isRetryableError(e){return e instanceof A?e.retryable:!(e instanceof Error)||e.message.includes("network")||e.message.includes("timeout")||e.message.includes("fetch")}calculateRetryDelay(e){return Math.min(this.config.retryConfig.baseDelay*Math.pow(2,e),this.config.retryConfig.maxDelay)+1e3*Math.random()}constructor(e,t){this.config=e,this.tokenFetcher=t,this.tokenInfo=null,this.refreshPromise=null,this.refreshTimer=null,this.isDestroyed=!1}}let _={refreshAdvanceTime:5,maxRetryAttempts:3,baseRetryDelay:1e3,maxRetryDelay:3e4},D=(0,m.tZ)("Runtime"),j=(0,c.forwardRef)((e,t)=>{let{project:r,src:h,mode:p,className:m="",onLoad:v,onError:y,title:T="Preview",seamless:S=!1,allow:j="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; camera; microphone; geolocation; fullscreen; payment",sandbox:q="allow-downloads allow-forms allow-modals allow-orientation-lock allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-presentation allow-same-origin allow-scripts allow-top-navigation",loading:O="eager",onRequestLogin:P,...N}=e,L=(0,c.useRef)(null),[W,F]=(0,c.useState)(()=>Date.now()),{track:H}=(0,I.s)(),[U,B]=(0,c.useState)(!1),{user:X}=(0,f.A)(),Y=(0,d.useRouter)(),z=w(()=>r.project_id);!function(e){let t=w(e.getLoginStatus),r=w(e.requestLogin);(0,c.useEffect)(()=>{var t,r;return t=e.getLoginStatus,r=e.requestLogin,l.d.onInvoke("getLoginStatus",async()=>t()),l.d.onInvoke("requestLogin",async e=>r(e)),()=>{l.d.offInvoke("getLoginStatus"),l.d.offInvoke("requestLogin")}},[t,r])}({getLoginStatus:()=>Promise.resolve({isLoggedIn:!!X}),requestLogin:P}),function(e){let t=w(e.innerRequest);(0,c.useEffect)(()=>{l.d.onInvoke("innerRequest",async e=>t(e.apiName,e.params))},[t])}({innerRequest:async(e,t)=>{D.info("innerRequest",{apiName:e,params:t}),await new Promise((e,t)=>{X?e(!0):(0,k.S)({title:"Please log in to continue.",description:"You’ll need to log in to take part in this activity.",cancelText:"Cancel",confirmText:"Log in",onCancel:()=>{t(Error("Login required"))},onConfirm:()=>{let t=(0,E.$)(!0,!0)+window.location.pathname+window.location.search;Y.push("".concat((0,E.$)(!0),"/login?returnTo=").concat(encodeURIComponent(t))),e(!0)}})});try{let n=await u(e,t,{projectId:r.project_id});return D.info("innerRequest result",n),n}catch(e){throw D.error("innerRequest error",e),e}}}),(0,c.useImperativeHandle)(t,()=>{let e={getIframe:()=>L.current,refresh:()=>{F(Date.now())}};return"editor"===p?{...e,toggleConsole:e=>{l.d.sendEvent("toggle_console",{visible:e})},clearConsole:()=>{l.d.sendEvent("clear_console",void 0)},addConsoleLog:function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];l.d.sendEvent("add_console_log",{level:e,message:t,args:r})}}:{...e}},[p,h]);let{getToken:K,forceRefresh:Z,isLoading:$,error:G}=function(e){let{projectId:t,refreshAdvanceTime:r=_.refreshAdvanceTime,maxRetryAttempts:n=_.maxRetryAttempts,baseRetryDelay:o=_.baseRetryDelay,maxRetryDelay:i=_.maxRetryDelay}=e,[s,a]=(0,c.useState)(!1),[l,d]=(0,c.useState)(null),h=(0,c.useRef)(null);return(0,c.useEffect)(()=>(h.current=new M({projectId:t,refreshAdvanceTime:r,retryConfig:{maxAttempts:n,baseDelay:o,maxDelay:i}},C.fetchToken),()=>{var e;null===(e=h.current)||void 0===e||e.destroy(),h.current=null}),[t,r,n,o,i]),{getToken:(0,c.useCallback)(async()=>{if(!h.current)throw new A("TokenManager not initialized","NOT_INITIALIZED");a(!0),d(null);try{return await h.current.getToken()}catch(t){let e=t instanceof A?t:new A(t instanceof Error?t.message:String(t),"UNKNOWN_ERROR");throw d(e),e}finally{a(!1)}},[]),forceRefresh:(0,c.useCallback)(async()=>{if(!h.current)throw new A("TokenManager not initialized","NOT_INITIALIZED");a(!0),d(null);try{await h.current.forceRefresh()}catch(t){let e=t instanceof A?t:new A(t instanceof Error?t.message:String(t),"UNKNOWN_ERROR");throw d(e),e}finally{a(!1)}},[]),isLoading:s,error:l}}({projectId:r.project_id});return(0,c.useEffect)(()=>{var e;let t=(e=async()=>{D.info("getToken",{projectId:r.project_id}),await new Promise((e,t)=>{X?e(!0):(0,k.S)({title:"Want to use this AI app?",description:"AI apps consume Credits. Log in to unlock an amazing experience!",cancelText:"Cancel",confirmText:"Log in",onCancel:()=>{t(Error("Login required"))},onConfirm:()=>{let t=(0,E.$)(!0,!0)+window.location.pathname+window.location.search;Y.push("".concat((0,E.$)(!0),"/login?returnTo=").concat(encodeURIComponent(t))),e(!0)}})});let e=await K();return D.info("getToken success",{projectId:r.project_id}),e},async t=>{let r=await e();t.headers.set("Authorization","Bearer ".concat(r))}),n=async e=>{let t="http://yourware-backend-prod.yourware-service-discovery-prod:8000";if(t&&e.url.includes("api.youware.com")){let r="aiapp.youware.com",n=t.match(/staging(\d*)/i);if(n){let e=n[1]||"";r="aiapp-staging".concat(e,".youware.com")}e.url=e.url.replace("api.youware.com",r)}},d=async e=>{H("call_ai_adk",{method:e.method,url:e.url,project_id:z(),runtime_mode:p,fetch_duration:e.duration});let t=e.response.headers.get("X-YW-Status"),r=e.response.headers.get("X-YW-Message"),n=e.response.headers.get("X-YW-Request-Id");if(t&&"0"!==t){if(H("call_ai_adk_error",{method:e.method,url:e.url,project_id:z(),runtime_mode:p,status:t,message:r,requestId:n}),"40200"===t){B(!0),b.X.sendMessage("CreditsUpdated");return}(0,x.P)({message:"API Request failed".concat(r?": "+r.slice(0,100):""),type:"error",duration:5e3})}};return function(e){let{messageManager:t,monitor:r,hooks:n}=e;a=t,t.onInvoke("fetch-proxy:fetch",async e=>{let t=Date.now();try{var s;let a=(s=e.headers,new Headers(s.entries)),l=e.body?function(e){switch(e.type){case"null":return null;case"string":case"json":return e.data;case"urlsearchparams":return new URLSearchParams(e.data);case"formdata":{let t=new FormData;for(let[r,n]of e.data)if("string"==typeof n)t.append(r,n);else{let e=new File([o(n.content,n.type)],n.name,{type:n.type,lastModified:n.lastModified});t.append(r,e)}return t}case"blob":return o(e.data.content,e.data.type);case"arraybuffer":return function(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=t.charCodeAt(e);return n.buffer}(e.data);case"stream":return o(e.data,"application/octet-stream");default:throw Error("Unknown serialized body type: ".concat(e.type))}}(e.body):null;l instanceof FormData&&a.has("content-type")&&a.delete("content-type"),(null==r?void 0:r.onRequest)&&await r.onRequest({requestId:e.requestId,url:e.url,method:e.method,headers:a,body:l,timestamp:t});let d={method:e.method,headers:a,body:l,credentials:e.credentials,mode:e.mode,cache:e.cache,redirect:e.redirect,referrer:e.referrer,referrerPolicy:e.referrerPolicy,integrity:e.integrity,keepalive:e.keepalive},c={requestId:e.requestId,url:e.url,method:e.method,headers:a,body:l,requestInit:d};(null==n?void 0:n.beforeSend)&&await n.beforeSend(c);let h=c.url,u=new AbortController;d.signal=u.signal;let g=await fetch(h,d),f={requestId:e.requestId,url:h,method:e.method,request:c,response:g,duration:Date.now()-t};if((null==n?void 0:n.afterResponse)&&await n.afterResponse(f),g.body){let r=g.body.getReader();i.set(e.requestId,{reader:r,abortController:u,chunks:[],startTime:t,response:g,requestId:e.requestId})}else(null==r?void 0:r.onResponse)&&await r.onResponse({requestId:e.requestId,status:g.status,statusText:g.statusText,headers:g.headers,duration:Date.now()-t,body:null});return{requestId:e.requestId,status:g.status,statusText:g.statusText,headers:function(e){let t=[];return e.forEach((e,r)=>{t.push([r,e])}),{entries:t}}(g.headers),type:g.type,url:g.url,redirected:g.redirected,ok:g.ok,bodyUsed:!1}}catch(t){throw(null==r?void 0:r.onError)&&await r.onError({requestId:e.requestId,type:t instanceof Error&&"AbortError"===t.name?"abort":"network",message:t instanceof Error?t.message:String(t)}),i.delete(e.requestId),t}}),t.onInvoke("fetch-proxy:stream-read",async e=>{let{requestId:n,chunkIndex:o}=e,s=i.get(n);if(!s)throw Error("No active stream for request ".concat(n));try{let{done:e,value:a}=await s.reader.read();if(e){if(null==r?void 0:r.onResponse){let e=s.chunks.reduce((e,t)=>e+t.length,0),t=new Uint8Array(e),n=0;for(let e of s.chunks)t.set(e,n),n+=e.length;let o=function(e,t){var r;let n=(null===(r=t.get("content-type"))||void 0===r?void 0:r.toLowerCase())||"";if(0===e.byteLength)return null;try{if(n.includes("application/json")){let t=new TextDecoder().decode(e);return JSON.parse(t)}if(n.includes("text/")||n.includes("application/xml")||n.includes("application/javascript")||n.includes("application/x-www-form-urlencoded"))return new TextDecoder().decode(e);return e}catch(t){if(console.warn("[Fetch Proxy] Failed to parse response body:",t),n.includes("application/json")||n.includes("text/"))try{return new TextDecoder().decode(e)}catch(e){}return e}}(t.buffer,s.response.headers);r.onResponse({requestId:s.requestId,status:s.response.status,statusText:s.response.statusText,headers:s.response.headers,duration:Date.now()-s.startTime,body:o})}return i.delete(n),t.sendEvent("fetch-proxy:stream-control",{requestId:n,action:"end"}),{requestId:n,chunk:new ArrayBuffer(0),done:!0,index:o}}(null==r?void 0:r.onResponse)&&s.chunks.push(a);let l=new ArrayBuffer(a.byteLength);return new Uint8Array(l).set(a),{requestId:n,chunk:l,done:!1,index:o}}catch(e){throw console.error("[Fetch Proxy Handler] Error in stream read:",e),i.delete(n),t.sendEvent("fetch-proxy:stream-control",{requestId:n,action:"error",error:e instanceof Error?e.message:String(e)}),(null==r?void 0:r.onError)&&r.onError({requestId:n,type:e instanceof Error&&"AbortError"===e.name?"abort":"network",message:e instanceof Error?e.message:String(e)}),e}}),s=t.onEvent("fetch-proxy:stream-control",e=>{if("abort"===e.action){let t=i.get(e.requestId);t&&(t.reader.cancel(),t.abortController.abort(),i.delete(e.requestId))}}),console.log("[Fetch Proxy Handler] Initialized on parent side")}({messageManager:l.d,monitor:{onRequest:async e=>{},onResponse:e=>{let t=function(e){var t,r;let n=e.body;if(((null===(r=e.headers)||void 0===r?void 0:null===(t=r.get)||void 0===t?void 0:t.call(r,"content-type"))||"").includes("text/event-stream")&&"string"==typeof e.body)try{n=function(e){if(!e||"string"!=typeof e)return e;let t=e.split("\n"),r=[],n={},o="";for(let e of t){if(""===e.trim()){Object.keys(n).length>0&&(r.push({...n}),n={});continue}if(e.startsWith("data: ")){let t=e.substring(6).trim();if("[DONE]"===t){n.type="done";continue}try{let e=JSON.parse(t);n={...n,...e},e.choices&&e.choices[0]&&e.choices[0].delta&&e.choices[0].delta.content?o+=e.choices[0].delta.content:e.delta&&e.delta.content?o+=e.delta.content:e.content&&(o+=e.content)}catch(e){o+=t}}else e.startsWith("event: ")?n.event=e.substring(7).trim():e.startsWith("id: ")?n.id=e.substring(4).trim():e.startsWith("retry: ")&&(n.retry=parseInt(e.substring(7).trim(),10))}return Object.keys(n).length>0&&r.push(n),{streamContent:o.trim()||null}}(e.body)}catch(t){R.error("Failed to parse SSE content:",t instanceof Error?t:Error(String(t))),n=e.body}return n}(e);if(e.status>=300){var r,n;R.error("request failed",{message:e.statusText,status:e.status,duration:e.duration,xw_status:null===(r=e.headers)||void 0===r?void 0:r.get("X-YW-Status"),xw_message:null===(n=e.headers)||void 0===n?void 0:n.get("X-YW-Message"),body:t})}},onError:e=>{R.error("request failed",{message:e.message})}},hooks:{beforeSend:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return async e=>{for(let r of t)await r(e)}}(n,t),afterResponse:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return async e=>{for(let r of t)await r(e)}}(d)}}),()=>{!function(){for(let[e,t]of i)t.reader.cancel(),t.abortController.abort();i.clear(),a&&(a.offInvoke("fetch-proxy:fetch"),a.offInvoke("fetch-proxy:stream-read"),a=null),s&&(s(),s=null)}()}},[]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(g.p,{isOpen:U,onClose:()=>B(!1),from:"editor"===p?"editor_AI_API_pop_up":"app_page_AI_API_pop_up"}),(0,n.jsx)("iframe",{ref:L,id:"youware-runtime",src:h,title:T,className:m,loading:O,seamless:S,allow:j,sandbox:q,onLoad:e=>{null==v||v()},onError:e=>{null==y||y(e.toString())},...N},W)]})});j.displayName="Runtime";let q=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.componentName||e.displayName||e.name||"Component",o=o=>(0,n.jsx)(y,{...t,componentName:r,children:(0,n.jsx)(e,{...o})});return o.displayName="withErrorBoundary(".concat(r,")"),o}(j)}}]);